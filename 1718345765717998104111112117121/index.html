<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Card</title>
<style>
  html, body {height:100%; margin:0;}
  body {background:#0b0b0f; color:#b6ffb6; font-family: Calibri, 'Segoe UI', Arial, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh;}
  .card { position:relative; max-width: 960px; width: 96vw; border:1px solid #2a8a57; border-radius:12px; padding:14px; text-align:center; box-shadow:0 1px 2px rgba(0,0,0,.4); background:#0e1614;}
  .viewer { width:100%; min-height: 320px; display:flex; align-items:center; justify-content:center; background:#0b1412; border-radius:10px; overflow:hidden; }
  .viewer.scroll-mode { display:block; max-height:82vh; overflow-y:auto; overflow-x:hidden; }
  video, img, iframe { border:none; border-radius:10px; }
  .img-fit { width:100%; height:auto; max-height:82vh; object-fit:contain; display:block; }
  .img-scroll { width:100%; height:auto; max-width:100%; display:block; }
  .pdf-frame { width:100%; height:70vh; border-radius:10px; }
  .toolbar { margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .btn { background:#0f1614; color:#b6ffb6; border:1px solid #2a8a57; padding:8px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
  .btn:hover { background:#12221a; }
  .btn[disabled] { opacity:.5; cursor:not-allowed; }
  .seg { display:inline-flex; border:1px solid #2a8a57; border-radius:10px; overflow:hidden; }
  .seg button { background:#0f1614; padding:8px 10px; border:none; color:#b6ffb6; cursor:pointer; }
  .seg button.active { background:#153325; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#0e1614; color:#b6ffb6; border:1px solid #2a8a57; padding:8px 14px; border-radius:999px; box-shadow:0 1px 2px rgba(0,0,0,.28); display:none; }
  @keyframes fadeInZoom { from { opacity:0; transform: scale(.98); } to { opacity:1; transform: scale(1); } }
  .media-anim { animation: fadeInZoom .6s ease both; }
  #confetti { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
  @media (max-width: 640px) {
    .card { width: 100vw; border-radius:0; border:none; }
    .viewer { min-height: 220px; }
    .pdf-frame { height: 60vh; }
  }
</style>
</head>
<body>
<div class="card">
  <canvas id="confetti"></canvas>
  <div id="viewer" class="viewer"></div>
  <img id="static-fallback" src="../assets/card.png" alt="" style="display:none; width:100%; border-radius:10px;" />
  <div class="toolbar">
    <span id="imgMode" class="seg" style="display:none;">
      <button id="fitBtn" class="active">適合螢幕</button>
      <button id="scrollBtn">原始尺寸（可捲動）</button>
    </span>
    <button id="shareBtn" class="btn">🔗 分享</button>
    <a id="pdfBtn" class="btn" href="#" download style="display:none;">🧾 下載 PDF</a>
  </div>
</div>

<div id="toast" class="toast">已複製連結</div>

<script>
const ASSETS = '../assets/';
let currentType = null;
let currentSrc = null;
let currentImgEl = null;

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg || '已複製連結';
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 1200);
}

async function tryFetch(url, type='text') {
  try { const res = await fetch(url, {cache:'no-store'}); if (!res.ok) return null; return type==='text' ? await res.text() : await res.blob(); }
  catch(e) { return null; }
}
function ytId(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if (u.hostname.includes('youtube')) {
      const v = u.searchParams.get('v'); if (v) return v;
      const parts = u.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('shorts'); if (i >= 0 && parts[i+1]) return parts[i+1];
      const j = parts.indexOf('embed'); if (j >= 0 && parts[j+1]) return parts[j+1];
    }
  } catch(e) { }
  return null;
}

function attachMedia(el) {
  el.classList.add('media-anim');
  const v = document.getElementById('viewer');
  v.innerHTML = '';
  v.classList.remove('scroll-mode');
  v.appendChild(el);
  document.getElementById('static-fallback').style.display = 'none';
  const pdfBtn = document.getElementById('pdfBtn');
  const imgMode = document.getElementById('imgMode');
  if (currentType === 'pdf') { pdfBtn.style.display = 'inline-block'; pdfBtn.href = currentSrc; } else { pdfBtn.style.display = 'none'; }
  if (currentType === 'image') { imgMode.style.display = 'inline-flex'; } else { imgMode.style.display = 'none'; }
}

function setImageMode(mode) {
  const v = document.getElementById('viewer');
  const fitBtn = document.getElementById('fitBtn');
  const scrollBtn = document.getElementById('scrollBtn');
  if (!currentImgEl) return;
  if (mode === 'scroll') {
    v.classList.add('scroll-mode');
    currentImgEl.classList.remove('img-fit');
    currentImgEl.classList.add('img-scroll');
    fitBtn.classList.remove('active');
    scrollBtn.classList.add('active');
    localStorage.setItem('card_img_mode', 'scroll');
  } else {
    v.classList.remove('scroll-mode');
    currentImgEl.classList.remove('img-scroll');
    currentImgEl.classList.add('img-fit');
    scrollBtn.classList.remove('active');
    fitBtn.classList.add('active');
    localStorage.setItem('card_img_mode', 'fit');
  }
}

function autoModeForImage(img) {
  const saved = localStorage.getItem('card_img_mode');
  if (saved === 'scroll') setImageMode('scroll'); else setImageMode('fit');
}

function render(type, src) {
  currentType = type; currentSrc = src; currentImgEl = null;
  if (type === 'youtube') {
    const id = ytId(src);
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    iframe.allowFullscreen = true; iframe.style.aspectRatio = '16/9';
    attachMedia(iframe);
  } else if (type === 'video') {
    const vid = document.createElement('video'); vid.controls = true; vid.playsInline = true; vid.style.width = '100%'; vid.style.height = 'auto';
    const source = document.createElement('source'); source.src = src; source.type = 'video/mp4';
    vid.appendChild(source); attachMedia(vid);
  } else if (type === 'image') {
    const img = document.createElement('img'); img.src = src; img.alt = ''; img.className = 'img-fit';
    currentImgEl = img; attachMedia(img); img.onload = ()=> autoModeForImage(img);
    img.addEventListener('dblclick', ()=> setImageMode(document.getElementById('viewer').classList.contains('scroll-mode') ? 'fit' : 'scroll'));
    let lastTap = 0;
    img.addEventListener('touchend', (e)=>{ const now = Date.now(); if (now - lastTap < 350) { e.preventDefault(); setImageMode(document.getElementById('viewer').classList.contains('scroll-mode') ? 'fit' : 'scroll'); } lastTap = now; }, {passive:false});
  } else if (type === 'pdf') {
    const iframe = document.createElement('iframe'); iframe.src = src; iframe.className = 'pdf-frame'; attachMedia(iframe);
  } else {
    document.getElementById('static-fallback').style.display = 'block';
  }
}

async function detectAndRender() {
  const jsonTxt = await tryFetch(ASSETS + 'card.json', 'text');
  if (jsonTxt) {
    try {
      const conf = JSON.parse(jsonTxt);
      const t = (conf.type || 'auto').toLowerCase();
      const s = conf.src || '';
      if (t === 'youtube') return render('youtube', s);
      if (t === 'video')   return render('video', s || ASSETS + 'card.mp4');
      if (t === 'image')   return render('image', s || ASSETS + 'card.png');
      if (t === 'pdf')     return render('pdf',   s || ASSETS + 'card.pdf');
      if (s) {
        const ext = s.split('.').pop().toLowerCase();
        if (ext === 'mp4') return render('video', s);
        if (['png','jpg','jpeg','webp','gif'].includes(ext)) return render('image', s);
        if (ext === 'pdf') return render('pdf', s);
        if (s.includes('youtu')) return render('youtube', s);
      }
    } catch(e) { /* ignore */ }
  }
  const urlTxt = await tryFetch(ASSETS + 'card.url', 'text');
  if (urlTxt) {
    const u = urlTxt.trim();
    if (u.includes('youtu')) return render('youtube', u);
    const ext = u.split('.').pop().toLowerCase();
    if (ext === 'mp4') return render('video', u);
    if (['png','jpg','jpeg','webp','gif'].includes(ext)) return render('image', u);
    if (ext === 'pdf') return render('pdf', u);
  }
  const png = await tryFetch(ASSETS + 'card.png', 'blob'); if (png) return render('image', ASSETS + 'card.png');
  const jpg = await tryFetch(ASSETS + 'card.jpg', 'blob'); if (jpg) return render('image', ASSETS + 'card.jpg');
  const webp = await tryFetch(ASSETS + 'card.webp', 'blob'); if (webp) return render('image', ASSETS + 'card.webp');
  const mp4 = await tryFetch(ASSETS + 'card.mp4', 'blob'); if (mp4) return render('video', ASSETS + 'card.mp4');
  const pdf = await tryFetch(ASSETS + 'card.pdf', 'blob'); if (pdf) return render('pdf', ASSETS + 'card.pdf');
  document.getElementById('static-fallback').style.display = 'block';
}

document.addEventListener('click', (e) => {
  if (e.target.id === 'fitBtn') setImageMode('fit');
  if (e.target.id === 'scrollBtn') setImageMode('scroll');
});

document.getElementById('shareBtn').onclick = async () => {
  const url = window.location.href;
  try {
    if (navigator.share) {
      await navigator.share({ title: 'Card', text: '來看看我們的心意！', url });
    } else if (navigator.clipboard) {
      await navigator.clipboard.writeText(url);
      showToast('連結已複製');
    } else {
      const ta = document.createElement('textarea'); ta.value = url; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); ta.remove(); showToast('連結已複製');
    }
  } catch(e) { }
};

function runConfetti(duration=2600) {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  let W,H; function resize() { W = canvas.width = canvas.offsetWidth; H = canvas.height = canvas.offsetHeight; }
  resize(); window.addEventListener('resize', resize);
  const colors = ['#ffdf6e','#ff9aa2','#9ec9ff','#b5f5a3','#ffd1dc','#c5b3ff'];
  const N = 180;
  const parts = Array.from({length:N}, (_,i)=>({
    x: Math.random()*W,
    y: -10 - Math.random()*H*0.3,
    r: 3 + Math.random()*4,
    c: colors[i%colors.length],
    vx: -1 + Math.random()*2,
    vy: 1 + Math.random()*2.5,
    a: Math.random()*Math.PI*2,
    va: -0.2 + Math.random()*0.4
  }));
  const start = performance.now();
  function tick(t) {
    const elapsed = t - start;
    ctx.clearRect(0,0,W,H);
    parts.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.a += p.va;
      ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a);
      ctx.fillStyle = p.c; ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2); ctx.restore();
      if (p.y > H + 20) { p.y = -10; p.x = Math.random()*W; }
    });
    if (elapsed < duration) requestAnimationFrame(tick);
    else { ctx.clearRect(0,0,W,H); }
  }
  requestAnimationFrame(tick);
}

detectAndRender();
runConfetti(2600);
</script>
</body>
</html>
