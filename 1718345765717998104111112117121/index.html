<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Card</title>
<style>
  html, body { height:100%; margin:0; }
  body { background:#0b0b0f; color:#b6ffb6; font-family: Calibri, 'Segoe UI', Arial, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; }
  .wrap { width: min(96vw, 1100px); }

  .card { position:relative; border:1px solid #2a8a57; border-radius:12px; padding:14px; background:#0e1614; box-shadow:0 1px 2px rgba(0,0,0,.4); }
  .topbar { display:flex; justify-content:flex-end; align-items:center; margin-bottom:10px; gap:8px; }
  .ctr { display:flex; align-items:center; gap:8px; }
  .btn { background:#0f1614; color:#b6ffb6; border:1px solid #2a8a57; padding:8px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
  .btn:hover { background:#12221a; }
  .btn[disabled] { opacity:.5; cursor:not-allowed; }

  .stage { position:relative; background:#0b1412; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .stage-inner { position:relative; width: min(92vw, 1000px); aspect-ratio: 3/2; }

  /* Book base */
  .book { position:absolute; inset:0; perspective:1600px; }
  .sheet { position:absolute; top:0; left:50%; width:50%; height:100%; transform-style:preserve-3d; transform-origin:left; transition: transform .9s cubic-bezier(.22,.61,.36,1); }
  .sheet .face { position:absolute; inset:0; backface-visibility:hidden; overflow:hidden; background:#111; display:flex; align-items:center; justify-content:center; }
  .sheet .face img { width:100%; height:100%; object-fit:cover; display:block; }
  .sheet .back { transform: rotateY(180deg); }

  /* Page curl shading */
  .sheet::before, .sheet::after {
    content:""; position:absolute; inset:-1px; pointer-events:none; border-radius:2px;
    background: radial-gradient(800px 100% at 0% 50%, rgba(0,0,0,.4), rgba(0,0,0,0) 60%);
    opacity:0; transition: opacity .25s linear;
  }
  .sheet.flipping::before { opacity:.55; }
  .sheet.flipped { transform: translateX(-100%) rotateY(-180deg); }
  .sheet.flipped::before { opacity:0; }

  /* Static pads under the stack */
  .pad-left, .pad-right { position:absolute; top:0; width:50%; height:100%; overflow:hidden; }
  .pad-left { left:0; }
  .pad-right { right:0; }
  .pad-left img, .pad-right img { width:100%; height:100%; object-fit:cover; display:block; }

  /* Nav arrows */
  .nav { position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; pointer-events:none; }
  .arrow { pointer-events:auto; user-select:none; background:rgba(15,22,20,.75); border:1px solid #2a8a57; width:42px; height:42px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .arrow:hover { background:#13231a; }
  .nav .prev { margin-left:10px; }
  .nav .next { margin-right:10px; }
  .arrow svg { width:20px; height:20px; fill:#b6ffb6; }
  .arrow.hidden { visibility:hidden; }

  .footer { display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px; }
  .pageinfo { font-variant-numeric: tabular-nums; opacity:.85; }

  /* Mobile single-page mode */
  @media (max-width: 720px) {
    .stage-inner { aspect-ratio: 3/4; }
    .pad-left { display:none; }
    .pad-right { left:0; right:auto; width:100%; }
    .book { perspective:1400px; }
    .sheet { left:0; width:100%; transform-origin:left; }
  }

  /* Confetti */
  #confetti { position:absolute; inset:0; pointer-events:none; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div class="ctr">
        <button class="btn" id="shareBtn">🔗 分享</button>
      </div>
    </div>

    <div class="stage">
      <div class="stage-inner">
        <canvas id="confetti"></canvas>
        <div class="pad-left"><img id="padLeft" alt=""></div>
        <div class="pad-right"><img id="padRight" alt=""></div>
        <div class="book" id="book"></div>
        <div class="nav">
          <div class="prev arrow" id="prevBtn" title="上一頁">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </div>
          <div class="next arrow" id="nextBtn" title="下一頁">
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="pageinfo"><span id="pageNow">1</span> / <span id="pageTotal">--</span></div>
    </div>
  </div>
</div>

<audio id="flipAudio" preload="auto"></audio>

<script>
const ASSETS = '../assets/book/';
const EXT_LIST = ['jpg','jpeg','png','webp'];
let PAGES = [];   // list of urls
let MODE = 'spread'; // 'spread' on desktop, 'single' on mobile
let sheetIndex = 0;  // flipped sheets count
let sheets = [];     // DOM sheets

const isMobile = matchMedia('(max-width: 720px)').matches;
MODE = isMobile ? 'single' : 'spread';

async function headOk(url) {
  try { const res = await fetch(url, { method:'GET', cache:'no-store' }); return res.ok; }
  catch(e){ return false; }
}

// Auto-detect pages: page-01..page-80
async function autoDetectPages() {
  const found = [];
  for (let i=1; i<=80; i++) {
    const base = ASSETS + 'page-' + String(i).padStart(2,'0') + '.';
    let ok = null;
    for (const ext of EXT_LIST) {
      if (await headOk(base + ext)) { ok = base + ext; break; }
    }
    if (ok) found.push(ok); else break;
  }
  return found;
}

function byId(id){ return document.getElementById(id); }

function makeSheet(leftUrl, rightUrl, z) {
  const sheet = document.createElement('div');
  sheet.className = 'sheet';
  sheet.style.zIndex = z;
  const front = document.createElement('div');
  front.className = 'face front';
  const fimg = document.createElement('img');
  fimg.alt=''; fimg.src = rightUrl || leftUrl || '';
  front.appendChild(fimg);

  const back = document.createElement('div');
  back.className = 'face back';
  const bimg = document.createElement('img');
  bimg.alt=''; bimg.src = (leftUrl ? leftUrl : (rightUrl || ''));
  back.appendChild(bimg);

  sheet.appendChild(front);
  sheet.appendChild(back);
  return sheet;
}

function renderBook() {
  const book = byId('book');
  book.innerHTML = '';
  sheets = [];
  sheetIndex = 0;

  byId('pageTotal').textContent = PAGES.length || '--';
  byId('pageNow').textContent = PAGES.length ? '1' : '0';

  if (!PAGES.length) {
    byId('padLeft').style.display = 'none';
    byId('padRight').style.display = 'none';
    byId('prevBtn').classList.add('hidden');
    byId('nextBtn').classList.add('hidden');
    return;
  }

  if (MODE === 'spread') {
    // Pads show first spread
    byId('padLeft').src = PAGES[0] || '';
    byId('padRight').src = PAGES[1] || PAGES[0] || '';
    const totalSheets = Math.ceil(PAGES.length / 2);
    for (let s=0; s<totalSheets; s++) {
      const leftIndex = s*2;
      const rightIndex = s*2 + 1;
      const sheet = makeSheet(PAGES[leftIndex] || '', PAGES[rightIndex] || '', (totalSheets - s) + 5);
      sheets.push(sheet);
      book.appendChild(sheet);
    }
  } else { // single page mode
    byId('padLeft').style.display = 'none';
    byId('padRight').src = PAGES[0];
    const totalSheets = PAGES.length - 1; // each flip moves from i -> i+1
    for (let s=0; s<totalSheets; s++) {
      const left = PAGES[s];      // current page (back side)
      const right = PAGES[s+1];   // next page (front side)
      const sheet = makeSheet(left, right, (totalSheets - s) + 5);
      sheets.push(sheet);
      book.appendChild(sheet);
    }
  }
  updateNavState();
}

function currentPageNumber() {
  if (!PAGES.length) return 0;
  if (MODE === 'spread') return Math.min(PAGES.length, sheetIndex*2 + 1);
  return Math.min(PAGES.length, sheetIndex + 1);
}

function updatePads() {
  if (!PAGES.length) return;
  if (MODE === 'spread') {
    const leftIdx = Math.min(PAGES.length-1, Math.max(0, sheetIndex*2));
    const rightIdx = Math.min(PAGES.length-1, sheetIndex*2 + 1);
    byId('padLeft').src = PAGES[leftIdx] || '';
    byId('padRight').src = PAGES[rightIdx] || PAGES[leftIdx] || '';
  } else {
    const cur = Math.min(PAGES.length-1, sheetIndex);
    byId('padRight').src = PAGES[cur];
  }
}

function updatePageInfo() {
  byId('pageNow').textContent = String(currentPageNumber());
}

function atStart(){ return sheetIndex === 0; }
function atEnd(){ return sheetIndex >= sheets.length; }

function updateNavState() {
  byId('prevBtn').classList.toggle('hidden', atStart());
  byId('nextBtn').classList.toggle('hidden', atEnd());
}

function playFlip(){ try{ const a = byId('flipAudio'); a.currentTime = 0; a.play(); }catch(e){} }

function nextPage() {
  if (atEnd()) return;
  const sheet = sheets[sheetIndex];
  sheet.classList.add('flipping');
  requestAnimationFrame(()=> sheet.classList.add('flipped'));
  sheet.style.zIndex = (5 + sheetIndex);
  sheetIndex++;
  updatePads();
  updatePageInfo();
  updateNavState();
  playFlip();
  setTimeout(()=> sheet.classList.remove('flipping'), 950);
}

function prevPage() {
  if (atStart()) return;
  sheetIndex--;
  const sheet = sheets[sheetIndex];
  sheet.classList.add('flipping');
  sheet.classList.remove('flipped');
  sheet.style.zIndex = (sheets.length - sheetIndex) + 5;
  updatePads();
  updatePageInfo();
  updateNavState();
  playFlip();
  setTimeout(()=> sheet.classList.remove('flipping'), 950);
}

function bindNav() {
  byId('nextBtn').onclick = ()=> nextPage();
  byId('prevBtn').onclick = ()=> prevPage();
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowRight') nextPage();
    if (e.key === 'ArrowLeft') prevPage();
  });
  // swipe
  let sx=null, sy=null, t0=0;
  const el = document.querySelector('.stage-inner');
  el.addEventListener('touchstart', (e)=>{
    if (!e.touches || !e.touches.length) return;
    const t = e.touches[0]; sx=t.clientX; sy=t.clientY; t0=Date.now();
  }, {passive:true});
  el.addEventListener('touchend', (e)=>{
    if (sx==null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - sx, dy=t.clientY - sy, dt=Date.now()-t0;
    sx=null;
    if (Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy) && dt<600){ if (dx<0) nextPage(); else prevPage(); }
  });
}

async function setupFlipSound(){
  const audio = byId('flipAudio');
  const tryList = ['flip.mp3','flip.wav','flip.ogg'];
  for (const name of tryList){
    const url = ASSETS + name;
    if (await headOk(url)){ audio.src = url; return; }
  }
  audio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA';
}

async function init(){
  await setupFlipSound();
  PAGES = await autoDetectPages();
  renderBook();
  bindNav();
  runConfetti(1400);
}
init();

// Share
byId('shareBtn').onclick = async ()=>{
  const url = location.href;
  try {
    if (navigator.share) await navigator.share({title:'Card', text:'來看看我們的心意！', url});
    else if (navigator.clipboard) { await navigator.clipboard.writeText(url); alert('連結已複製'); }
    else { const ta = document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('連結已複製'); }
  } catch(e){}
};

// Confetti
function runConfetti(duration=1800) {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  let W,H; function resize(){ W = canvas.width = canvas.offsetWidth; H = canvas.height = canvas.offsetHeight; }
  resize(); addEventListener('resize', resize);
  const colors = ['#ffdf6e','#ff9aa2','#9ec9ff','#b5f5a3','#ffd1dc','#c5b3ff'];
  const N = 110;
  const parts = Array.from({length:N}, (_,i)=>({ x: Math.random()*W, y: -10 - Math.random()*H*0.3, r:3+Math.random()*4, c: colors[i%colors.length], vx:-1+Math.random()*2, vy:1+Math.random()*2.5, a:Math.random()*Math.PI*2, va:-0.2+Math.random()*0.4 }));
  const start = performance.now();
  function tick(t){
    const elapsed = t - start;
    ctx.clearRect(0,0,W,H);
    parts.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.a += p.va;
      ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a);
      ctx.fillStyle = p.c; ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2); ctx.restore();
      if (p.y > H + 20) { p.y = -10; p.x = Math.random()*W; }
    });
    if (elapsed < duration) requestAnimationFrame(tick);
    else ctx.clearRect(0,0,W,H);
  }
  requestAnimationFrame(tick);
}
</script>
</body>
</html>
