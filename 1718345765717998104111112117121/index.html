<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Card â€“ Simple</title>
<link rel="preload" as="image" href="../assets/book/page-01.png">
<link rel="preload" as="image" href="../assets/book/page-02.png">
<style>
  :root{ --fade-ms:280 }
  html,body{height:100%;margin:0}
  body{background:#0b0b0f;color:#b6ffb6;font-family:Segoe UI,Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh}
  #confettiFS{position:fixed;inset:0;pointer-events:none;z-index:100}
  .wrap{width:min(92vw,980px)}
  .card{position:relative;border:1px solid #2a8a57;border-radius:12px;padding:10px;background:#0e1614;box-shadow:0 1px 2px rgba(0,0,0,.4)}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .brand{font-weight:600;opacity:.9}
  .btn{background:#0f1614;color:#b6ffb6;border:1px solid #2a8a57;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#12221a}
  .stage{position:relative;background:#0b1412;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .stage-inner{position:relative;width:min(78vw,760px);aspect-ratio:3/4;background:#0b1412; box-sizing:border-box;}
  /* æ¡Œæ©Ÿï¼šé¿å…åœ–ç‰‡é•·é‚Šè¢«åˆ‡ï¼Œä¸Šä¸‹ä¿ç•™å®‰å…¨é‚Š */
  @media (min-width: 900px){
    .stage-inner{ padding: clamp(22px, 3.5vh, 64px) clamp(16px, 2vw, 32px); }
    .page img{ box-sizing:border-box; padding: clamp(18px, 2.6vh, 48px) clamp(12px, 1.6vw, 28px); }
  }
  .page{position:absolute;inset:0}
  .page img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#0b1412;transition:opacity var(--fade-ms)ms ease}
  #imgA{opacity:1} #imgB{opacity:0}
  .nav{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
  .arrow{pointer-events:auto;user-select:none;background:rgba(15,22,20,.75);border:1px solid #2a8a57;width:42px;height:42px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .arrow.hidden{visibility:hidden}
  .footer{display:flex;justify-content:space-between;gap:10px;margin-top:8px;align-items:center}
  .pageinfo{font-variant-numeric:tabular-nums;opacity:.85}
  .links{display:flex;gap:8px}
  .loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50;background:transparent}
  .loader .box{display:flex;gap:10px;align-items:center;background:rgba(11,20,18,.66);border:1px solid #2a8a57;padding:10px 14px;border-radius:10px}
  .spinner{width:18px;height:18px;border:3px solid rgba(182,255,182,.25);border-top-color:#b6ffb6;border-radius:50%;animation:sp 1s linear infinite}
  .loadingText{font-size:14px;letter-spacing:.3px}
  @keyframes sp{to{transform:rotate(1turn)}}
</style>
</head>
<body>
<canvas id="confettiFS"></canvas>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div class="brand">Simple Viewer</div>
      <button id="shareBtn" class="btn">ğŸ”— åˆ†äº«</button>
    </div>
    <div class="stage">
      <div class="stage-inner">
        <div class="loader" id="loader"><div class="box"><div class="spinner"></div><div class="loadingText">Loadingâ€¦</div></div></div>
        <div class="page"><img id="imgA" alt="page"></div>
        <div class="page"><img id="imgB" alt="page"></div>
        <div class="nav">
          <div id="prevBtn" class="arrow hidden" title="ä¸Šä¸€å¼µ"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="#b6ffb6" d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></div>
          <div id="nextBtn" class="arrow" title="ä¸‹ä¸€å¼µ"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="#b6ffb6" d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg></div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="pageinfo"><span id="pageNow">1</span> / <span id="pageTotal">â€”</span></div>
      <div class="links">
        <a class="btn" id="pdfBtn" href="#" target="_blank" style="display:none">ğŸ“„ é–‹å•Ÿ PDF</a>
      </div>
    </div>
  </div>
</div>
<script>
const ASSETS = new URL('../assets/book/', location.href).href;
const SHARE_URL = 'https://nuncstans0321.github.io/manythanks/';
const FAST_PREFIX = 'page-';
const FAST_EXT = 'png';
const MAX_PAGES = 200;
let PAGES=[], idx=0, topIsA=true, preNext=null, prePrev=null;

const $=id=>document.getElementById(id);

function runConfetti(duration=2400){
  const c=document.getElementById('confettiFS')||document.createElement('canvas');
  c.id='confettiFS'; if(!c.parentNode) document.body.prepend(c);
  const x=c.getContext('2d'); function rs(){c.width=innerWidth;c.height=innerHeight} rs(); addEventListener('resize',rs);
  const cols=['#ffdf6e','#ff9aa2','#9ec9ff','#b5f5a3','#ffd1dc','#c5b3ff'];
  const N=Math.round((c.width*c.height)/30000)+50;
  const parts=Array.from({length:N},(_,i)=>({x:Math.random()*c.width,y:-10-Math.random()*c.height*.3,r:3+Math.random()*4,c:cols[i%cols.length],vx:-1+Math.random()*2,vy:1+Math.random()*2.5,a:Math.random()*Math.PI*2,va:-.2+Math.random()*.4}));
  const st=performance.now();
  function tick(t){const el=t-st;x.clearRect(0,0,c.width,c.height);parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.a+=p.va;x.save();x.translate(p.x,p.y);x.rotate(p.a);x.fillStyle=p.c;x.fillRect(-p.r,-p.r,p.r*2,p.r*2);x.restore();if(p.y>c.height+20){p.y=-10;p.x=Math.random()*c.width;}}); if(el<duration)requestAnimationFrame(tick); else x.clearRect(0,0,c.width,c.height);}
  requestAnimationFrame(tick);
}

function preload(url){ return new Promise(res=>{ const im=new Image(); im.onload=im.onerror=()=>res(true); im.decoding='async'; im.loading='eager'; im.src=url; }); }
function firstUrl(){ return `${ASSETS}${FAST_PREFIX}01.${FAST_EXT}`; }
async function fastScan(){
  const out=[];
  for(let i=1;i<=MAX_PAGES;i++){
    const n=String(i).padStart(2,'0');
    const u=`${ASSETS}${FAST_PREFIX}${n}.${FAST_EXT}`;
    try{ const r=await fetch(u,{method:'HEAD',cache:'reload'}); if(!r.ok) break; out.push(u); }catch(e){ break; }
  }
  return out;
}
async function pdfExists(){
  const url=ASSETS+'book.pdf';
  try{const r=await fetch(url,{method:'HEAD',cache:'reload'}); if(r.ok){const a=$('pdfBtn'); a.href=url; a.style.display='inline-flex';}}catch(e){}
}

function setTop(url){
  const A=$('imgA'),B=$('imgB');
  const top=topIsA?A:B, bot=topIsA?B:A;
  bot.style.opacity=0; bot.removeAttribute('srcset'); bot.src=url;
  requestAnimationFrame(()=>{ bot.style.opacity=1; top.style.opacity=0; topIsA=!topIsA; });
  $('pageNow').textContent=String(idx+1);
  $('prevBtn').classList.toggle('hidden', idx===0);
  $('nextBtn').classList.toggle('hidden', idx>=PAGES.length-1);
}
function prefetAround(){
  preNext = (idx<PAGES.length-1)? new Image(): null;
  if(preNext){ preNext.src = PAGES[idx+1]; }
  prePrev = (idx>0)? new Image(): null;
  if(prePrev){ prePrev.src = PAGES[idx-1]; }
}
function next(){ if(idx>=PAGES.length-1) return; idx++; setTop(PAGES[idx]); prefetAround(); }
function prev(){ if(idx<=0) return; idx--; setTop(PAGES[idx]); prefetAround(); }

function bindNav(){
  $('nextBtn').onclick=next; $('prevBtn').onclick=prev;
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') next(); if(e.key==='ArrowLeft') prev(); });
  let sx=null,sy=null,t0=0; const el=document.querySelector('.stage-inner');
  el.addEventListener('touchstart',e=>{if(!e.touches?.length) return; const t=e.touches[0]; sx=t.clientX; sy=t.clientY; t0=Date.now();},{passive:true});
  el.addEventListener('touchend',e=>{ if(sx==null) return; const t=e.changedTouches[0]; const dx=t.clientX-sx,dy=t.clientY-sy,dt=Date.now()-t0; sx=null; if(Math.abs(dx)>40&&Math.abs(dx)>Math.abs(dy)&&dt<800){ if(dx<0) next(); else prev(); } });
}
$('shareBtn').onclick=async ()=>{
  const url='https://nuncstans0321.github.io/manythanks/';
  try{ if(navigator.share) await navigator.share({title:'Card',text:'ä¾†çœ‹çœ‹æˆ‘å€‘çš„å¿ƒæ„ï¼',url});
    else if(navigator.clipboard){ await navigator.clipboard.writeText(url); alert('é€£çµå·²è¤‡è£½'); }
    else { const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('é€£çµå·²è¤‡è£½'); } }catch(e){}
};

(async function boot(){
  runConfetti(2400);
  const loader=$('loader');
  // å…ˆæŠŠç¬¬ä¸€å¼µä¸Ÿçµ¦ <img>ï¼ˆä¸é—œ loaderï¼‰
  $('imgA').src = firstUrl();
  // æƒææ‰€æœ‰é 
  PAGES = await fastScan();
  $('pageTotal').textContent = PAGES.length || 'â€”';

  // ç­‰ç¬¬ä¸€ã€äºŒå¼µå¯ç”¨æ‰é—œ Loadingï¼›è‹¥åªæœ‰ä¸€å¼µå°±ç­‰ä¸€å¼µ
  const need=[PAGES[0]]; if(PAGES.length>=2) need.push(PAGES[1]);
  await Promise.all(need.map(preload));
  loader.style.display='none';

  idx=0; setTop(PAGES[idx]); prefetAround(); bindNav(); pdfExists();
})();
</script>
</body>
</html>
