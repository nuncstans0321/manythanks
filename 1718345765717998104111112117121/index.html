<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎉 電子賀卡</title>
<style>
  html, body {height:100%; margin:0;}
  body {background:#0b0b0f; color:#b6ffb6; font-family: Calibri, 'Segoe UI', Arial, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh;}
  .card { max-width: 960px; width: 94vw; border:1px solid #2a8a57; border-radius:12px; padding:18px; text-align:center; box-shadow:0 1px 2px rgba(0,0,0,.4); background:#0e1614;}
  h1 { margin:0 0 12px; }
  .viewer { width:100%; min-height: 320px; display:flex; align-items:center; justify-content:center; background:#0b1412; border-radius:10px; overflow:hidden; }
  video, img, iframe { width:100%; height:auto; border:none; border-radius:10px; }
  .pdf-frame { width:100%; height:70vh; border-radius:10px; }
  .meta { margin-top:8px; font-size:14px; opacity:.8; display:none; }
</style>
</head>
<body>
<div class="card">
  <h1>🎉 Access Granted</h1>
  <div id="viewer" class="viewer"></div>
  <!-- 強化：靜態圖片後備，萬一 JS 探測失敗仍可顯示 -->
  <img id="static-fallback" src="../assets/card.png" alt="card" style="display:none; width:100%; border-radius:10px;" />
  <div id="meta" class="meta"></div>
</div>

<script>
const ASSETS = '../assets/';
async function tryFetch(url, type='text') {
  try { const res = await fetch(url, {cache:'no-store'}); if (!res.ok) return null; return type==='text' ? await res.text() : await res.blob(); }
  catch(e) { return null; }
}
function ytId(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if (u.hostname.includes('youtube')) {
      const v = u.searchParams.get('v'); if (v) return v;
      const parts = u.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('shorts'); if (i >= 0 && parts[i+1]) return parts[i+1];
      const j = parts.indexOf('embed'); if (j >= 0 && parts[j+1]) return parts[j+1];
    }
  } catch(e) { }
  return null;
}
function render(type, src, title) {
  const v = document.getElementById('viewer'); const meta = document.getElementById('meta');
  v.innerHTML = ''; meta.textContent = title || ''; meta.style.display = title ? 'block' : 'none';
  document.getElementById('static-fallback').style.display = 'none';
  if (type === 'youtube') {
    const id = ytId(src);
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    iframe.allowFullscreen = true; iframe.style.aspectRatio = '16/9';
    v.appendChild(iframe);
  } else if (type === 'video') {
    const vid = document.createElement('video'); vid.controls = true; vid.playsInline = true;
    const source = document.createElement('source'); source.src = src; source.type = 'video/mp4';
    vid.appendChild(source); v.appendChild(vid);
  } else if (type === 'image') {
    const img = document.createElement('img'); img.src = src; img.alt = title || 'image'; v.appendChild(img);
  } else if (type === 'pdf') {
    const iframe = document.createElement('iframe'); iframe.src = src; iframe.className = 'pdf-frame'; v.appendChild(iframe);
  } else {
    // 最後手段：顯示靜態圖片
    document.getElementById('static-fallback').style.display = 'block';
  }
}
async function detectAndRender() {
  // 1) card.json
  const jsonTxt = await tryFetch(ASSETS + 'card.json', 'text');
  if (jsonTxt) {
    try {
      const conf = JSON.parse(jsonTxt);
      const t = (conf.type || 'auto').toLowerCase();
      const s = conf.src || '';
      const title = conf.title || '';
      if (t === 'youtube') return render('youtube', s, title);
      if (t === 'video')   return render('video', s || ASSETS + 'card.mp4', title);
      if (t === 'image')   return render('image', s || ASSETS + 'card.png', title);
      if (t === 'pdf')     return render('pdf',   s || ASSETS + 'card.pdf', title);
      if (s) {
        const ext = s.split('.').pop().toLowerCase();
        if (ext === 'mp4') return render('video', s, title);
        if (['png','jpg','jpeg','webp','gif'].includes(ext)) return render('image', s, title);
        if (ext === 'pdf') return render('pdf', s, title);
        if (s.includes('youtu')) return render('youtube', s, title);
      }
    } catch(e) { /* ignore */ }
  }
  // 2) card.url
  const urlTxt = await tryFetch(ASSETS + 'card.url', 'text');
  if (urlTxt) {
    const u = urlTxt.trim();
    if (u.includes('youtu')) return render('youtube', u);
    const ext = u.split('.').pop().toLowerCase();
    if (ext === 'mp4') return render('video', u);
    if (['png','jpg','jpeg','webp','gif'].includes(ext)) return render('image', u);
    if (ext === 'pdf') return render('pdf', u);
  }
  // 3) 固定檔名探測（blob 失敗時 fallback 用 <img> 直接載）
  const png = await tryFetch(ASSETS + 'card.png', 'blob');
  if (png) return render('image', ASSETS + 'card.png', 'Simple Card');
  const jpg = await tryFetch(ASSETS + 'card.jpg', 'blob');
  if (jpg) return render('image', ASSETS + 'card.jpg', 'Card');
  const webp = await tryFetch(ASSETS + 'card.webp', 'blob');
  if (webp) return render('image', ASSETS + 'card.webp', 'Card');
  const mp4 = await tryFetch(ASSETS + 'card.mp4', 'blob');
  if (mp4) return render('video', ASSETS + 'card.mp4', 'Video');
  const pdf = await tryFetch(ASSETS + 'card.pdf', 'blob');
  if (pdf) return render('pdf', ASSETS + 'card.pdf', 'PDF');
  // 最後：顯示靜態 fallback（即使 fetch 被擋也能渲染）
  document.getElementById('static-fallback').style.display = 'block';
}
detectAndRender();
</script>
</body>
</html>
