<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>這裡有一份可疑的金流...</title>
<style>
  html, body {height:100%; margin:0;}
  body {background:#0b0b0f; color:#d0ffd0; font-family: Calibri, 'Segoe UI', Arial, sans-serif;}
  .wrap { padding:24px; max-width:1280px; margin:0 auto; }
  .panel { background:rgba(10,14,14,.55); border:1px solid #164; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);}
  h1 { margin:0 0 6px; font-size:20px; color:#91f591; }
  .hint { color:#91f591; opacity:.9 }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  button, input { background:#0f1614; color:#b6ffb6; border:1px solid #2a8a57; padding:8px 12px; border-radius:10px; font-size:14px; }
  button:hover { background:#11211a; cursor:pointer; }
  input[readonly] { background:#0e1412 }
  .chip { display:inline-block; padding:6px 10px; border:1px solid #2a8a57; border-radius:999px; color:#b6ffb6; }
  .hidden { display:none }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#0e1614; color:#b6ffb6; border:1px solid #2a8a57; padding:8px 14px; border-radius:999px; box-shadow:0 1px 2px rgba(0,0,0,.28); display:none; }

  /* Excel-like white sheet */
  .excel { border:1px solid #CFCFCF; border-radius:12px; overflow:hidden; background:#ffffff; color:#111; }
  .excel .toolbar { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid #E6E6E6; background:linear-gradient(#FDFEFE, #F6F7F8); }
  .excel .toolbar .fx { font-weight:700; margin-right:6px; color:#555; }
  .excel .toolbar input { flex:1; border:1px solid #DADCE0; background:#fff; color:#333; }
  .excel .tablewrap { max-height:420px; overflow:auto; position:relative; }
  .excel .tablewrap::-webkit-scrollbar { height: 12px; width: 12px; }
  .excel .tablewrap::-webkit-scrollbar-track { background:#E9F5EA; border-left:1px solid #CDE6D0; }
  .excel .tablewrap::-webkit-scrollbar-thumb { background:#7ED37E; border:2px solid #E9F5EA; border-radius:10px; }
  .excel .tablewrap { scrollbar-color: #7ED37E #E9F5EA; scrollbar-width: auto; }
  .excel .colletters { display:grid; grid-template-columns: 50px 90px 420px 420px 100px 160px; border-bottom:1px solid #E6E6E6; background:#F8FAFB; }
  .excel .colletters div { padding:6px 8px; font-weight:700; color:#555; text-align:center; border-right:1px solid #E6E6E6; }
  .excel .colletters div:last-child { border-right:none; }
  table.tx { width:100%; border-collapse:separate; border-spacing:0; }
  table.tx colgroup col:nth-child(1) { width:50px; }
  table.tx colgroup col:nth-child(2) { width:90px; }
  table.tx colgroup col:nth-child(3) { width:420px; }
  table.tx colgroup col:nth-child(4) { width:420px; }
  table.tx colgroup col:nth-child(5) { width:100px; }
  table.tx colgroup col:nth-child(6) { width:160px; }
  thead th { position:sticky; top:0; z-index:2; background:#E2EFDA; color:#2F6627; font-weight:700; border-bottom:1px solid #C6E0B4; border-right:1px solid #E6E6E6; padding:8px; }
  thead th:last-child { border-right:none; }
  tbody td { border-bottom:1px solid #E6E6E6; border-right:1px solid #E6E6E6; padding:8px; color:#111; background:#fff; }
  tbody td:last-child { border-right:none; }
  tbody tr:hover td { background:#F7FBFF; }
  td.rownum { position:sticky; left:0; background:#FAFAFA; z-index:1; text-align:right; color:#666; }
  td.txid { text-align:center; font-weight:600; color:#222; }
  td.addr { font-family: Consolas, Menlo, Monaco, monospace; font-size:12px; word-break:break-all; line-height:1.2; color:#111; }
  td.amount { text-align:right; font-variant-numeric: tabular-nums; }
  td.time { text-align:center; color:#333; }
  .tail { font-weight:600; color:inherit; }
  .tail.reveal { color:#0a0; font-weight:800; filter: drop-shadow(0 0 6px rgba(0,255,0,.4)); }
  @keyframes blink { 0%,49%{opacity:1} 50%,99%{opacity:.2} 100%{opacity:1} }
  .blink { animation: blink 1s infinite; }

  .codebox { background:#0e1614; border:1px solid #2a8a57; border-radius:10px; padding:12px 14px; color:#b6ffb6; font-weight:700; letter-spacing:.03em; }

  /* Celebration overlay with steps */
  .cele { position:fixed; inset:0; background: radial-gradient(1200px 600px at 50% 20%, rgba(60,180,120,.25), rgba(0,0,0,.75)); display:none; align-items:center; justify-content:center; flex-direction:column; text-align:center; }
  .cele .digits, .cele .msg, .cele .relay { font-family: Consolas, Menlo, monospace; letter-spacing:.04em; color:#b6ffb6; }
  .cele .digits { font-size:22px; margin-bottom:10px; }
  .cele .relay { font-size:20px; opacity:.95; }
  .cele .msg { margin-top:14px; font-size:24px; color:#9df59d; }
  .loader { display:inline-block; width:18px; height:18px; border:2px solid #9df59d; border-top-color: transparent; border-radius:50%; vertical-align:middle; animation: spin 0.8s linear infinite; margin-left:8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { display:none; }

  /* Shatter effect */
  .shard { display:inline-block; will-change: transform, opacity; }
  @keyframes explode { to { transform: translate(var(--tx), var(--ty)) rotate(var(--rot)); opacity:0; filter: blur(2px); } }
  .shatter-on .shard { animation: explode .65s ease-out forwards; }
</style>
</head>
<body>
<div class="wrap">

  <div class="panel">
    <h1>這裡有一份可疑的金流...</h1>
    <div class="hint">看看這張金流圖有什麼特別之處</div>
  </div>

  <div class="panel excel">
    <div class="toolbar">
      <span class="fx">fx</span>
      <input id="fx" readonly placeholder="公式 / 內容 預覽（滑過任一儲存格查看）" />
      <button id="hint">提示 Hint</button>
    </div>
    <div class="colletters">
      <div></div><div>A</div><div>B</div><div>C</div><div>D</div><div>E</div>
    </div>
    <div class="tablewrap">
      <table class="tx" id="tx">
        <colgroup><col/><col/><col/><col/><col/><col/></colgroup>
        <thead>
          <tr>
            <th>#</th>
            <th>TxID</</th>
            <th>From Address</th>
            <th>To Address</th>
            <th>USDT</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="panel" id="qa">
    <p>Q1：有沒有發現金流圖的共同特徵？</p>
    <div class="row">
      <button id="q1-yes">有</button>
      <button id="q1-no">沒有</button>
    </div>
    <div id="q2" class="hidden" style="margin-top:10px;">
      <p>Q2：你覺得它和學員們的座號有關嗎？</p>
      <div class="row">
        <button id="q2-yes">有關</button>
        <button id="q2-no">不確定</button>
      </div>
    </div>
  </div>

  <div class="panel hidden" id="reveal">
    <div class="row"><span class="chip">授權碼</span><span class="hint">（不含 62，依座號由小到大串接）</span></div>
    <div id="code" class="codebox"></div>
    <div class="row" style="margin-top:10px;">
      <button id="copy-code">複製授權碼</button>
    </div>
  </div>

  <div class="panel hidden" id="builder">
    <div class="row"><span class="chip">最後一步</span><span class="hint">把授權碼貼在網址後面，就能進入電子賀卡</span></div>
    <div class="row" style="margin-top:8px;">
      <label>網站根網址：</label>
      <input id="base" value="https://nuncstans0321.github.io/manythanks/" style="min-width:360px" />
      <button id="make">產生完整網址</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="full" readonly style="min-width:520px" placeholder="完整網址將顯示在此…" />
      <button id="open" class="hidden">開啟我們的心意</button>
    </div>
  </div>

</div>

<div id="toast" class="toast">已複製</div>

<!-- Celebration overlay -->
<div id="cele" class="cele">
  <div class="digits" id="celeDigits"></div>
  <div class="relay hidden" id="celeRelay">接力傳遞美好的祝願… <span class="loader"></span></div>
  <div class="msg hidden" id="celeMsg">請接收我們滿滿的愛與生日祝福～</div>
</div>

<script>
// ===== Render data =====
const rows = [{"TxID": "TX01", "From": "0x582d84fd846ee20a0aaa255ede1220a2ca262017", "To": "0x98d4a31f266ffdd402b6003e41885ab0c5c62017", "Amount": "103.7", "Time": "2025-08-01 10:02:00"}, {"TxID": "TX02", "From": "0x98d4a31f266ffdd402b6003e41885ab0c5c62017", "To": "0x4a8e18163d1acb867ac467859ba30d0a7e862018", "Amount": "107.4", "Time": "2025-08-01 10:04:00"}, {"TxID": "TX03", "From": "0x4a8e18163d1acb867ac467859ba30d0a7e862018", "To": "0x662d3130cfe46b8dd669065fe90f9cb502162034", "Amount": "111.1", "Time": "2025-08-01 10:06:00"}, {"TxID": "TX04", "From": "0x662d3130cfe46b8dd669065fe90f9cb502162034", "To": "0x05a44e69e26f01794d2b3ddae8cad9bf15262057", "Amount": "114.8", "Time": "2025-08-01 10:08:00"}, {"TxID": "TX05", "From": "0x05a44e69e26f01794d2b3ddae8cad9bf15262057", "To": "0x2db04084e52e6caa58397a9b754d3a9aa2262065", "Amount": "118.5", "Time": "2025-08-01 10:10:00"}, {"TxID": "TX06", "From": "0x2db04084e52e6caa58397a9b754d3a9aa2262065", "To": "0xd7dae8431339c544ddf1f7f350dfefad10262071", "Amount": "122.2", "Time": "2025-08-01 10:12:00"}, {"TxID": "TX07", "From": "0xd7dae8431339c544ddf1f7f350dfefad10262071", "To": "0xb1b511651454c0afa3bebc39315bdb66cb362079", "Amount": "125.9", "Time": "2025-08-01 10:14:00"}, {"TxID": "TX08", "From": "0xb1b511651454c0afa3bebc39315bdb66cb362079", "To": "0x88900e372abb6aa3ee91e856c32e8d578f362098", "Amount": "129.6", "Time": "2025-08-01 10:16:00"}, {"TxID": "TX09", "From": "0x88900e372abb6aa3ee91e856c32e8d578f362098", "To": "0x033b9528fc6d256b799fee0cad797ac173662104", "Amount": "133.3", "Time": "2025-08-01 10:18:00"}, {"TxID": "TX10", "From": "0x033b9528fc6d256b799fee0cad797ac173662104", "To": "0x02fe74851a09b642b946cf5d78e56aecad562111", "Amount": "137.0", "Time": "2025-08-01 10:20:00"}, {"TxID": "TX11", "From": "0x02fe74851a09b642b946cf5d78e56aecad562111", "To": "0x93d491ad9316a16ea3b0d6b19d8125a4b9762112", "Amount": "140.7", "Time": "2025-08-01 10:22:00"}, {"TxID": "TX12", "From": "0x93d491ad9316a16ea3b0d6b19d8125a4b9762112", "To": "0x04d3723fb934d70807043eb72afd6a3f92f62117", "Amount": "144.4", "Time": "2025-08-01 10:24:00"}, {"TxID": "TX13", "From": "0x04d3723fb934d70807043eb72afd6a3f92f62117", "To": "0x11598a72fb43b2dbdc48f0c84eaf391fd8862121", "Amount": "148.1", "Time": "2025-08-01 10:26:00"}];

function tdAddr(addr) {
  const head = addr.slice(0, -5);
  const tail = addr.slice(-5); // 62XXX
  return `<span class="head">${head}</span><span class="tail">${tail}</span>`;
}

function setFX(text){ document.getElementById('fx').value = text; }

function renderTable() {
  const tb = document.getElementById('tbody'); tb.innerHTML = '';
  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="rownum xl-cell" data-loc="A${idx+2}">${idx+1}</td>
      <td class="txid xl-cell" data-loc="B${idx+2}">${r.TxID}</td>
      <td class="addr xl-cell" data-loc="C${idx+2}">${tdAddr(r.From)}</td>
      <td class="addr xl-cell" data-loc="D${idx+2}">${tdAddr(r.To)}</td>
      <td class="amount xl-cell" data-loc="E${idx+2}">${r.Amount}</td>
      <td class="time xl-cell" data-loc="F${idx+2}">${r.Time}</td>
    `;
    tb.appendChild(tr);
  });
  document.querySelectorAll('.xl-cell').forEach(td => {
    td.addEventListener('mouseenter', () => setFX(td.innerText.trim()));
    td.addEventListener('mouseleave', () => setFX(''));
  });
}
renderTable();

// ===== Hint & QA =====
function doHint() {
  document.querySelectorAll('.tail').forEach(el => {
    el.classList.add('reveal','blink');
    setTimeout(()=> el.classList.remove('blink'), 1800);
  });
}
document.getElementById('hint').onclick = () => doHint();

const qa = document.getElementById('qa');
const q2 = document.getElementById('q2');
const reveal = document.getElementById('reveal');
const builder = document.getElementById('builder');
const openBtn = document.getElementById('open');

document.getElementById('q1-yes').onclick = () => { q2.classList.remove('hidden'); };
document.getElementById('q1-no').onclick = () => { doHint(); };
document.getElementById('q2-yes').onclick = () => { document.querySelectorAll('.tail').forEach(el=>el.classList.add('reveal')); showCode(); };
document.getElementById('q2-no').onclick = () => { doHint(); };

function computeCode() {
  const set = rows.map(r => parseInt(r.To.slice(-3), 10)).sort((a,b)=>a-b);
  return set.join('');
}

function showCode() {
  qa.classList.add('hidden');
  const cd = computeCode();
  document.getElementById('code').textContent = cd;
  reveal.classList.remove('hidden');
}

// ===== Safe URL builder (prevents duplicate code) =====
function buildCardUrl(base, code) {
  let b = (base || '').trim();
  b = b.split('#')[0].split('?')[0];
  b = b.replace(/index\.html$/i, '');
  if (!b.endsWith('/')) b += '/';
  // strip trailing /digits/ if already there
  b = b.replace(/\/(\d{6,})(\/)??$/i, '/');
  return b + code + '/index.html';
}

const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 1000); }

document.getElementById('copy-code').onclick = async ()=>{
  try { await navigator.clipboard.writeText(document.getElementById('code').textContent); showToast('授權碼已複製'); }
  catch(e) { showToast('複製失敗'); }
  builder.classList.remove('hidden');
};

document.getElementById('make').onclick = ()=>{
  const base = document.getElementById('base').value.trim();
  const cd = document.getElementById('code').textContent.trim();
  const full = buildCardUrl(base, cd);
  const fullInput = document.getElementById('full');
  fullInput.value = full;
  if (full.length > 0) openBtn.classList.remove('hidden');
};

// ===== Shatter + Sequential digits + Blessing, then open =====
function shatterTable() {
  const cells = document.querySelectorAll('#tx tbody td');
  cells.forEach(td => {
    const text = td.innerText;
    td.innerHTML = '';
    for (const ch of text) {
      const span = document.createElement('span');
      span.textContent = ch;
      span.className = 'shard';
      const angle = Math.random()*Math.PI*2;
      const dist = 40 + Math.random()*90;
      const tx = Math.cos(angle)*dist;
      const ty = Math.sin(angle)*dist;
      const rot = (Math.random()*2-1)*45;
      span.style.setProperty('--tx', tx+'px');
      span.style.setProperty('--ty', ty+'px');
      span.style.setProperty('--rot', rot+'deg');
      span.style.animationDelay = (Math.random()*0.12)+'s';
      td.appendChild(span);
    }
  });
  document.body.classList.add('shatter-on');
}

function sequentialDigits(arr) {
  const cele = document.getElementById('cele');
  const out = document.getElementById('celeDigits');
  const relay = document.getElementById('celeRelay');
  const msg = document.getElementById('celeMsg');
  cele.style.display = 'flex';
  out.textContent = '';
  relay.classList.add('hidden');
  msg.classList.add('hidden');

  let i = 0;
  return new Promise(resolve => {
    const iv = setInterval(()=> {
      if (i >= arr.length) {
        clearInterval(iv);
        relay.classList.remove('hidden'); // show "接力傳遞美好的祝願…" + spinner
        setTimeout(()=> {
          relay.classList.add('hidden');
          msg.classList.remove('hidden'); // "請接收我們滿滿的愛與生日祝福～"
          setTimeout(resolve, 1200); // wait a bit before opening
        }, 1200); // loading 1.2s
        return;
      }
      out.textContent += (i === 0 ? '' : ' → ') + arr[i];
      i++;
    }, 180); // each 0.18s
  });
}

openBtn.onclick = async ()=>{
  const base = document.getElementById('base').value.trim();
  const cd = document.getElementById('code').textContent.trim();
  const url = buildCardUrl(base, cd); // recompute safely
  const fullInput = document.getElementById('full');
  fullInput.value = url; // keep synced

  openBtn.disabled = true;
  shatterTable();
  const tails = rows.map(r => parseInt(r.To.slice(-3), 10)).sort((a,b)=>a-b);
  await sequentialDigits(tails);
  window.open(url, '_blank');
  openBtn.disabled = false;
};
</script>
</body>
</html>
